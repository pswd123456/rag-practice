
services:
  # ----------------------------------------------------------------
  # 1. åŸºç¡€è®¾æ–½æœåŠ¡ (Database & Storage)
  # ----------------------------------------------------------------
  
  # Postgres æ•°æ®åº“
  db:
    image: postgres:15
    restart: always
    environment:
      # è¿™é‡Œçš„è´¦å·å¯†ç å¿…é¡»å’Œä½  .env é‡Œçš„ DATABASE_URL å¯¹åº”
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: rag_db
      TZ: Asia/Shanghai
    volumes:
      - pg_data:/var/lib/postgresql/data
    networks:
      - rag-net
    ports:
      - "5432:5432" # æš´éœ²ç»™å®¿ä¸»æœºï¼Œæ–¹ä¾¿ä½ ç”¨ Navicat/DBeaver è¿æ¥
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U myuser -d rag_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis ç¼“å­˜/é˜Ÿåˆ—
  redis:
    image: redis:latest
    restart: always
    networks:
      - rag-net
    ports:
      - "6379:6379"

  # MinIO å¯¹è±¡å­˜å‚¨
  minio:
    image: minio/minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000" # API ç«¯å£
      - "9001:9001" # æ§åˆ¶å°ç«¯å£
    volumes:
      - minio_data:/data
    networks:
      - rag-net

  # Chroma å‘é‡æ•°æ®åº“ (Server Mode)
  chroma:
    image: chromadb/chroma:latest
    restart: always
    volumes:
      - chroma_data:/chroma/chroma
    networks:
      - rag-net
    ports:
      - "8001:8000" # <--- å…³é”®ä¿®æ”¹ï¼šæ˜ å°„åˆ°å®¿ä¸»æœº 8001ï¼Œé¿å¼€ FastAPI çš„ 8000
    environment:
      - IS_PERSISTENT=TRUE

  # ----------------------------------------------------------------
  # 2. åº”ç”¨æœåŠ¡ (API & Worker)
  # ----------------------------------------------------------------

  # FastAPI åç«¯
  api:
    build: .
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "8000:8000" # å®¿ä¸»æœºè®¿é—®å…¥å£
      - "8002:8001" # mkdocså…¥å£
    env_file:
      - .env # åŠ è½½ .env æ–‡ä»¶ä¸­çš„ API KEY
    environment:
      # --- è¦†ç›– .env ä¸­çš„ localhost é…ç½® ---
      # å®¹å™¨å†…äº’è®¿å¿…é¡»ç”¨æœåŠ¡å (db, redis, minio, chroma)
      - DATABASE_URL=postgresql+psycopg2://myuser:mypassword@db:5432/rag_db
      - REDIS_HOST=redis
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_BUCKET_NAME=rag-knowledge-base
      # æŒ‡å‘ Chroma å®¹å™¨å†…éƒ¨ç«¯å£ (8000)
      - CHROMA_SERVER_HOST=chroma
      - CHROMA_SERVER_PORT=8000
      # é€ä¼  API Key (å¦‚æœ .env é‡Œæœ‰ï¼Œè¿™é‡Œä¼šè‡ªåŠ¨è¯»å–ï¼Œä¸éœ€è¦ç¡¬ç¼–ç )
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - TZ=Asia/Shanghai
      # å…¶ä»–é…ç½®ä¿æŒé»˜è®¤æˆ–ä» .env è¯»å–
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      chroma:
        condition: service_started
    networks:
      - rag-net
    volumes:
      # - ./embed_models:/app/embed_models # æŒ‚è½½æ¨¡å‹æƒé‡
      - ./logs:/app/logs                 # æŒ‚è½½æ—¥å¿—
      # ğŸ‘‡ æ–°å¢è¿™ä¸€è¡Œï¼šæŠŠå½“å‰ç›®å½•æŒ‚è½½åˆ°å®¹å™¨çš„ /app
      # è¿™æ ·ä½ æ”¹æœ¬åœ°ä»£ç ï¼Œå®¹å™¨é‡Œç«‹å³ç”Ÿæ•ˆï¼ˆé‡å¯å®¹å™¨å³å¯ï¼Œä¸ç”¨ Buildï¼‰
      - ./:/app
      - /etc/localtime:/etc/localtime:ro  # <--- æŒ‚è½½å®¿ä¸»æœºæ—¶é’Ÿæ–‡ä»¶
      - /etc/timezone:/etc/timezone:ro    # <--- æŒ‚è½½æ—¶åŒºé…ç½®
  # å¼‚æ­¥ä»»åŠ¡ Worker
  worker:
    build: .
    command: arq app.worker.WorkerSettings
    env_file:
      - .env
    environment:
      # åŒ API é…ç½®
      - DATABASE_URL=postgresql+psycopg2://myuser:mypassword@db:5432/rag_db
      - REDIS_HOST=redis
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_BUCKET_NAME=rag-knowledge-base
      - CHROMA_SERVER_HOST=chroma
      - CHROMA_SERVER_PORT=8000
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - TZ=Asia/Shanghai
      - /etc/localtime:/etc/localtime:ro  # <--- æŒ‚è½½å®¿ä¸»æœºæ—¶é’Ÿæ–‡ä»¶
      - /etc/timezone:/etc/timezone:ro    # <--- æŒ‚è½½æ—¶åŒºé…ç½®
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      chroma:
        condition: service_started
    networks:
      - rag-net
    volumes:
      # - ./embed_models:/app/embed_models
      - ./logs:/app/logs

 # ----------------------------------------------------------------
  # 3. å¯è§‚æµ‹æ€§æœåŠ¡ (Langfuse V3)
  # ----------------------------------------------------------------
  
  # [Core] Langfuse Web Server (API & UI)
  langfuse-server:
    image: langfuse/langfuse:3
    depends_on:
      - langfuse-db
      - clickhouse
      - redis
      - minio
    ports:
      - "3001:3000" # å®¿ä¸»æœº 3001 -> å®¹å™¨ 3000
    environment:
      - NODE_ENV=production
      # --- å…³é”®ä¿®å¤ï¼šClickHouse è¿æ¥ä¸² (V3 å¿…é¡») ---
      - CLICKHOUSE_URL=http://clickhouse:8123
      - CLICKHOUSE_MIGRATION_URL=clickhouse://clickhouse:9000
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=langfuse
      - CLICKHOUSE_CLUSTER_ENABLED=false
      # --- æ•°æ®åº“ ---
      - DATABASE_URL=postgresql://langfuse:langfuse@langfuse-db:5432/langfuse
      # --- ç¼“å­˜ä¸é˜Ÿåˆ— (å¤ç”¨ç°æœ‰ Redis) ---
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_AUTH=
      # --- å¯¹è±¡å­˜å‚¨ (å¤ç”¨ç°æœ‰ MinIO) ---
      - LANGFUSE_S3_EVENT_UPLOAD_BUCKET=langfuse-events
      - LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT=http://minio:9000
      - LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID=minioadmin
      - LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY=minioadmin
      - LANGFUSE_S3_EVENT_UPLOAD_REGION=us-east-1
      - LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE=true
      # --- å®‰å…¨ä¸è®¤è¯ (.envé…ç½®) ---
      - NEXTAUTH_SECRET=${LANGFUSE_NEXTAUTH_SECRET}
      - SALT=${LANGFUSE_SALT}
      - ENCRYPTION_KEY=${LANGFUSE_ENCRYPTION_KEY}
      - NEXTAUTH_URL=http://localhost:3001
      # --- è‡ªåŠ¨åˆå§‹åŒ– (å¯é€‰) ---
      - LANGFUSE_INIT_ORG_ID=my-org
      - LANGFUSE_INIT_PROJECT_ID=my-project
      - LANGFUSE_INIT_USER_EMAIL=admin@example.com
      - LANGFUSE_INIT_USER_NAME=Admin
      - LANGFUSE_INIT_USER_PASSWORD=password123
    networks:
      - rag-net

  # [Core] Langfuse Worker (V3 æ–°å¢ï¼Œå¿…é¡»å¯åŠ¨ï¼)
  langfuse-worker:
    image: langfuse/langfuse-worker:3
    depends_on:
      - langfuse-db
      - clickhouse
      - redis
      - minio
    environment:
      - NODE_ENV=production
      # Worker ä¹Ÿéœ€è¦è¿æ¥ ClickHouse
      - CLICKHOUSE_URL=http://clickhouse:8123
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=langfuse
      - CLICKHOUSE_CLUSTER_ENABLED=false
      - DATABASE_URL=postgresql://langfuse:langfuse@langfuse-db:5432/langfuse
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_AUTH=
      - LANGFUSE_S3_EVENT_UPLOAD_BUCKET=langfuse-events
      - LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT=http://minio:9000
      - LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID=minioadmin
      - LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY=minioadmin
      - LANGFUSE_S3_EVENT_UPLOAD_REGION=us-east-1
      - LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE=true
      - SALT=${LANGFUSE_SALT}
      - ENCRYPTION_KEY=${LANGFUSE_ENCRYPTION_KEY}
    networks:
      - rag-net

  # [DB] Langfuse ä¸“ç”¨ Postgres
  langfuse-db:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: langfuse
      POSTGRES_PASSWORD: langfuse
      POSTGRES_DB: langfuse
    volumes:
      - langfuse_pg_data:/var/lib/postgresql/data
    networks:
      - rag-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U langfuse"]
      interval: 5s
      timeout: 5s
      retries: 5

  # [DB] ClickHouse (OLAP æ•°æ®åº“)
  clickhouse:
    image: clickhouse/clickhouse-server
    restart: always
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    environment:
      - CLICKHOUSE_DB=default
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=langfuse
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    ports:
      - "8123:8123" # HTTP ç«¯å£
      - "9002:9000" # Native ç«¯å£
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_log:/var/log/clickhouse-server
    networks:
      - rag-net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  pg_data:
  minio_data:
  chroma_data:
  langfuse_pg_data:
  clickhouse_data:
  clickhouse_log:

networks:
  rag-net:
    driver: bridge