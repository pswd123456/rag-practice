
services:
  # ----------------------------------------------------------------
  # 1. åŸºç¡€è®¾æ–½æœåŠ¡ (Database & Storage)
  # ----------------------------------------------------------------
  
  # Postgres æ•°æ®åº“
  db:
    image: postgres:15
    restart: always
    environment:
      # è¿™é‡Œçš„è´¦å·å¯†ç å¿…é¡»å’Œä½  .env é‡Œçš„ DATABASE_URL å¯¹åº”
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: rag_db
      TZ: Asia/Shanghai
    volumes:
      - pg_data:/var/lib/postgresql/data
    networks:
      - rag-net
    ports:
      - "5432:5432" # æš´éœ²ç»™å®¿ä¸»æœºï¼Œæ–¹ä¾¿ä½ ç”¨ Navicat/DBeaver è¿æ¥
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U myuser -d rag_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis ç¼“å­˜/é˜Ÿåˆ—
  redis:
    image: redis:latest
    restart: always
    networks:
      - rag-net
    ports:
      - "6379:6379"

  # MinIO å¯¹è±¡å­˜å‚¨
  minio:
    image: minio/minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000" # API ç«¯å£
      - "9001:9001" # æ§åˆ¶å°ç«¯å£
    volumes:
      - minio_data:/data
    networks:
      - rag-net

  # Chroma å‘é‡æ•°æ®åº“ (Server Mode)
  chroma:
    image: chromadb/chroma:latest
    restart: always
    volumes:
      - chroma_data:/chroma/chroma
    networks:
      - rag-net
    ports:
      - "8001:8000" # <--- å…³é”®ä¿®æ”¹ï¼šæ˜ å°„åˆ°å®¿ä¸»æœº 8001ï¼Œé¿å¼€ FastAPI çš„ 8000
    environment:
      - IS_PERSISTENT=TRUE

  # ----------------------------------------------------------------
  # 2. åº”ç”¨æœåŠ¡ (API & Worker)
  # ----------------------------------------------------------------

  # FastAPI åç«¯
  api:
    build: .
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "8000:8000" # å®¿ä¸»æœºè®¿é—®å…¥å£
      - "8002:8001" # mkdocså…¥å£
    env_file:
      - .env # åŠ è½½ .env æ–‡ä»¶ä¸­çš„ API KEY
    environment:
      # --- è¦†ç›– .env ä¸­çš„ localhost é…ç½® ---
      # å®¹å™¨å†…äº’è®¿å¿…é¡»ç”¨æœåŠ¡å (db, redis, minio, chroma)
      - DATABASE_URL=postgresql+psycopg2://myuser:mypassword@db:5432/rag_db
      - REDIS_HOST=redis
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_BUCKET_NAME=rag-knowledge-base
      # æŒ‡å‘ Chroma å®¹å™¨å†…éƒ¨ç«¯å£ (8000)
      - CHROMA_SERVER_HOST=chroma
      - CHROMA_SERVER_PORT=8000
      # é€ä¼  API Key (å¦‚æœ .env é‡Œæœ‰ï¼Œè¿™é‡Œä¼šè‡ªåŠ¨è¯»å–ï¼Œä¸éœ€è¦ç¡¬ç¼–ç )
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - TZ=Asia/Shanghai
      # å…¶ä»–é…ç½®ä¿æŒé»˜è®¤æˆ–ä» .env è¯»å–
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      chroma:
        condition: service_started
    networks:
      - rag-net
    volumes:
      # - ./embed_models:/app/embed_models # æŒ‚è½½æ¨¡å‹æƒé‡
      - ./logs:/app/logs                 # æŒ‚è½½æ—¥å¿—
      # ğŸ‘‡ æ–°å¢è¿™ä¸€è¡Œï¼šæŠŠå½“å‰ç›®å½•æŒ‚è½½åˆ°å®¹å™¨çš„ /app
      # è¿™æ ·ä½ æ”¹æœ¬åœ°ä»£ç ï¼Œå®¹å™¨é‡Œç«‹å³ç”Ÿæ•ˆï¼ˆé‡å¯å®¹å™¨å³å¯ï¼Œä¸ç”¨ Buildï¼‰
      - ./:/app
      - /etc/localtime:/etc/localtime:ro  # <--- æŒ‚è½½å®¿ä¸»æœºæ—¶é’Ÿæ–‡ä»¶
      - /etc/timezone:/etc/timezone:ro    # <--- æŒ‚è½½æ—¶åŒºé…ç½®
  # å¼‚æ­¥ä»»åŠ¡ Worker
  worker:
    build: .
    command: arq app.worker.WorkerSettings
    env_file:
      - .env
    environment:
      # åŒ API é…ç½®
      - DATABASE_URL=postgresql+psycopg2://myuser:mypassword@db:5432/rag_db
      - REDIS_HOST=redis
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_BUCKET_NAME=rag-knowledge-base
      - CHROMA_SERVER_HOST=chroma
      - CHROMA_SERVER_PORT=8000
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - TZ=Asia/Shanghai
      - /etc/localtime:/etc/localtime:ro  # <--- æŒ‚è½½å®¿ä¸»æœºæ—¶é’Ÿæ–‡ä»¶
      - /etc/timezone:/etc/timezone:ro    # <--- æŒ‚è½½æ—¶åŒºé…ç½®
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      chroma:
        condition: service_started
    networks:
      - rag-net
    volumes:
      # - ./embed_models:/app/embed_models
      - ./logs:/app/logs

volumes:
  pg_data:
  minio_data:
  chroma_data:

networks:
  rag-net:
    driver: bridge